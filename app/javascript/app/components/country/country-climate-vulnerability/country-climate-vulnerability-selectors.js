import { createSelector } from 'reselect';
import isEmpty from 'lodash/isEmpty';

const getIso = state => state.iso || null;
const getAdaptations = state => state.adaptations || null;

const getSection = (sections, slug) => sections.find(s => s.slug === slug);

const getData = (sections, iso, slug) => {
  const section = getSection(sections, slug);
  return (
    section &&
    section.values &&
    section.values.find(country => country.location === iso)
  );
};

const getListData = (sections, iso, slug) => {
  const items = sections.filter(section => section.slug.startsWith(slug));
  const itemList = [];
  if (
    !items.some(item => item.values.some(country => country.location === iso))
  ) {
    itemList.push('No data');
  } else {
    items.forEach(item => {
      const countryHasItem = item.values.find(
        country => country.location === iso && country.value === true
      );
      if (countryHasItem) itemList.push(item.name);
    });
  }
  return itemList;
};

const getListMetadata = (sections, iso, slug) => {
  const section = getSection(sections, slug);
  const locationUrl = section.values.find(country => country.location === iso);
  return locationUrl && locationUrl.value;
};

export const getSectionData = createSelector(
  [getIso, getAdaptations],
  (iso, adaptations) => {
    const sections = adaptations.data;
    if (!iso || isEmpty(sections)) return null;

    return [
      {
        sectionType: 'CIRCULAR',
        title: getSection(sections, 'poverty_14').name,
        slug: 'poverty_14',
        data: getData(sections, iso, 'poverty_14')
      },
      {
        sectionType: 'LIST',
        title: 'Key hazards',
        slug: 'key_hazard',
        data: getListData(sections, iso, 'hazard'),
        metadataUrl: getListMetadata(sections, iso, 'wb_urls')
      },
      {
        sectionType: 'LINE',
        title: getSection(sections, 'climate_risks').name,
        slug: 'climate_risks',
        data: getData(sections, iso, 'climate_risks'),
        maximum: getSection(sections, 'climate_risks').maximum
      },
      {
        sectionType: 'LINE',
        title: getSection(sections, 'vulnerability').name,
        slug: 'vulnerability',
        data: getData(sections, iso, 'vulnerability'),
        maximum: getSection(sections, 'vulnerability').maximum
      },
      {
        sectionType: 'LINE',
        title: getSection(sections, 'readiness').name,
        slug: 'readiness',
        data: getData(sections, iso, 'readiness'),
        maximum: getSection(sections, 'readiness').maximum
      },
      {
        sectionType: 'LINK',
        slug: 'link'
      }
    ];
  }
);

export default {
  getSectionData
};
